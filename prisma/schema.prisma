generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model user {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  avatarUrl        String?
  email            String   @unique
  role             UserRole @default(USER)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  username         String?
  activeCampaignId String?  @db.ObjectId
  darkMode         Boolean  @default(false)

  // Relations
  activeCampaign  campaign?        @relation("UserActiveCampaign", fields: [activeCampaignId], references: [id])
  campaignMembers CampaignMember[]
  updates         Update[]
  rules           Rule[]
  infos           Info[]
  notes           Note[]
  creatures       Creature[]
  mapPosts        MapPost[]
  merchants       Merchant[]
}

model campaign {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  description       String?
  infoBackgroundUrl String? // URL for custom background image on info page
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  activeUsers user[]           @relation("UserActiveCampaign")
  members     CampaignMember[]
  updates     Update[]
  rules       Rule[]
  infos       Info[]
  notes       Note[]
  quests      Quest[]
  questTypes  QuestType[]
  creatures   Creature[]
  mapPosts    MapPost[]
  merchants   Merchant[]
  currencies  Currency[]
  playerKeep  PlayerKeep?
}

model CampaignMember {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  userId        String       @db.ObjectId
  campaignId    String       @db.ObjectId
  role          CampaignRole @default(PLAYER) // Role within this specific campaign
  characterName String? // Character name for this campaign
  joinedAt      DateTime     @default(now())

  user     user     @relation(fields: [userId], references: [id])
  campaign campaign @relation(fields: [campaignId], references: [id])

  @@unique([userId, campaignId]) // Prevent duplicate memberships
}

// ---------- Content Models for the Tabs ----------

model Update {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  title      String
  content    String
  createdAt  DateTime @default(now())
  authorId   String   @db.ObjectId
  campaignId String   @db.ObjectId

  author   user     @relation(fields: [authorId], references: [id])
  campaign campaign @relation(fields: [campaignId], references: [id])
}

model Rule {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  title      String
  content    String // Markdown content
  category   String? // For organizing rules into sections
  order      Int      @default(0) // For manual ordering within categories
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  authorId   String   @db.ObjectId
  campaignId String   @db.ObjectId

  author   user     @relation(fields: [authorId], references: [id])
  campaign campaign @relation(fields: [campaignId], references: [id])

  @@index([campaignId, category, order])
}

model Info {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String // Brief description of the info
  body        String // Markdown content for the main body
  category    String? // For organizing info into sections (e.g., "World Lore", "Character Creation")
  order       Int      @default(0) // For manual ordering within categories
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  authorId    String   @db.ObjectId
  campaignId  String   @db.ObjectId

  author   user     @relation(fields: [authorId], references: [id])
  campaign campaign @relation(fields: [campaignId], references: [id])

  @@index([campaignId, category, order])
}

model Note {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  title      String? // Optional title for the note
  content    String
  tags       String[] // Array of tags for organization
  isShared   Boolean  @default(false) // Whether note can be edited by all campaign members
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  authorId   String   @db.ObjectId
  campaignId String   @db.ObjectId

  author   user     @relation(fields: [authorId], references: [id])
  campaign campaign @relation(fields: [campaignId], references: [id])

  @@index([campaignId, authorId, createdAt])
  @@index([campaignId, isShared, createdAt])
}

model MapPost {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  imageUrl    String // URL to the map image
  tags        String[] // Array of tags for categorization and searching
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  authorId    String   @db.ObjectId
  campaignId  String   @db.ObjectId

  author   user     @relation(fields: [authorId], references: [id])
  campaign campaign @relation(fields: [campaignId], references: [id])

  @@index([campaignId, createdAt])
}

model Quest {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  status      QuestStatus @default(AVAILABLE)
  reward      String?
  difficulty  String?
  createdAt   DateTime    @default(now())
  campaignId  String      @db.ObjectId
  questTypeId String?     @db.ObjectId

  campaign  campaign   @relation(fields: [campaignId], references: [id])
  questType QuestType? @relation(fields: [questTypeId], references: [id])
}

model QuestType {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  campaignId  String   @db.ObjectId
  createdAt   DateTime @default(now())

  campaign campaign @relation(fields: [campaignId], references: [id])
  quests   Quest[]

  @@unique([campaignId, name])
}

model Creature {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  category    String   @default("NPC") // NPC, Monster, Human, etc.
  tags        String[] // Array of tags for flexible categorization
  avatarUrl   String? // Optional image URL
  isPrivate   Boolean  @default(false) // Private creatures only visible to DM/Admin

  // D&D Stats
  armorClass Int?
  hitPoints  Int?
  speed      String? // e.g., "30 ft., fly 60 ft."

  // Ability Scores
  strength     Int?
  dexterity    Int?
  constitution Int?
  intelligence Int?
  wisdom       Int?
  charisma     Int?

  // Combat & Skills
  challengeRating     String? // e.g., "1/4", "5", "15"
  proficiencyBonus    Int?
  skills              String? // JSON string for complex skill data
  savingThrows        String? // JSON string for saving throw bonuses
  damageResistances   String?
  damageImmunities    String?
  conditionImmunities String?
  senses              String? // e.g., "darkvision 60 ft., passive Perception 12"
  languages           String? // e.g., "Common, Draconic"

  // D&D Features (stored as JSON for flexibility)
  traits           String? // JSON array of traits
  actions          String? // JSON array of actions
  legendaryActions String? // JSON array of legendary actions
  lairActions      String? // JSON array of lair actions
  spellcasting     String? // JSON object for spellcasting info

  // Metadata
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  creatorId  String   @db.ObjectId
  campaignId String   @db.ObjectId

  creator  user     @relation(fields: [creatorId], references: [id])
  campaign campaign @relation(fields: [campaignId], references: [id])

  @@index([campaignId, category])
  @@index([campaignId, name])
}

model Merchant {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  city        String
  description String?
  location    String? // Specific location within the city (e.g., "Market Square", "North Gate")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  authorId    String   @db.ObjectId
  campaignId  String   @db.ObjectId

  // Relations
  author     user        @relation(fields: [authorId], references: [id])
  campaign   campaign    @relation(fields: [campaignId], references: [id])
  stockItems StockItem[]

  @@index([campaignId, city])
  @@index([campaignId, name])
}

model PlayerKeep {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  iconUrl     String? // URL for player keep icon/image
  description String? // Description of the player keep
  notes       String? // DM notes for custom requests, items, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  campaignId  String   @unique @db.ObjectId

  // Relations
  campaign   campaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  facilities Facility[]
  hirelings  Hireling[]
  checkIns   KeepCheckIn[]
}

model Facility {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  name           String
  description    String? // Description of the facility
  upkeepAmount   Float? // Weekly upkeep cost (optional)
  upkeepCurrency String? // Currency abbreviation (e.g., "gp")
  profitAmount   Float? // Weekly profit (optional)
  profitCurrency String? // Currency abbreviation (e.g., "gp")
  notes          String? // Custom notes for the DM
  craftingItems  Json? // Array of items being crafted: [{name: string, weeksRemaining: number, originalWeeks: number}]
  recurringItems Json? // Array of items produced: [{name: string, quantity: number, craftingDuration: number, progressWeeks: number}] - craftingDuration is weeks per cycle, progressWeeks tracks accumulated time
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  playerKeepId   String   @db.ObjectId

  // Relations
  playerKeep PlayerKeep @relation(fields: [playerKeepId], references: [id], onDelete: Cascade)

  @@index([playerKeepId])
}

model Hireling {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  name           String
  description    String? // Description of the hireling
  salaryAmount   Float? // Weekly salary cost (optional)
  salaryCurrency String? // Currency abbreviation (e.g., "gp")
  profitAmount   Float? // Weekly profit from services (optional)
  profitCurrency String? // Currency abbreviation (e.g., "gp")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  playerKeepId   String   @db.ObjectId

  // Relations
  playerKeep PlayerKeep @relation(fields: [playerKeepId], references: [id], onDelete: Cascade)

  @@index([playerKeepId])
}

model KeepCheckIn {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  weeksAway    Int // Number of weeks the party was away
  breakdown    Json // Detailed breakdown of costs and profits
  netProfit    Json // Net profit/loss for each currency type
  createdAt    DateTime @default(now())
  playerKeepId String   @db.ObjectId

  // Relations
  playerKeep PlayerKeep @relation(fields: [playerKeepId], references: [id], onDelete: Cascade)

  @@index([playerKeepId])
  @@index([createdAt])
}

model Currency {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  name         String // e.g., "Gold Pieces", "Silver Coins", "Tokens"
  abbreviation String // e.g., "gp", "sc", "tkn"
  description  String? // Optional description
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  campaignId   String   @db.ObjectId

  // Relations
  campaign   campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  stockItems StockItem[]

  @@unique([campaignId, abbreviation]) // Prevent duplicate abbreviations per campaign
  @@index([campaignId])
}

model StockItem {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  itemName    String
  description String?
  price       Float // Price value
  currencyId  String    @db.ObjectId // Reference to Currency model
  quantity    Int? // null means unlimited stock
  type        StockType // STAPLE or ROTATING
  available   Boolean   @default(true) // For temporarily disabling items
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  merchantId  String    @db.ObjectId

  // Relations
  merchant Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  currency Currency @relation(fields: [currencyId], references: [id])

  @@index([merchantId, type])
  @@index([merchantId, available])
  @@index([currencyId])
}

enum QuestStatus {
  AVAILABLE
  IN_PROGRESS
  UNAVAILABLE
  COMPLETED
}

enum StockType {
  STAPLE
  ROTATING
}

enum UserRole {
  USER
  ADMIN
}

enum CampaignRole {
  PLAYER
  DM
}
